---
title: "Modelling lipid physiology and energy imbalance during weight loss."
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Mathematical model

This document introduces a mathematical model for the lipid physiology and energy imbalance during a great weight loss. It consists in a system of ODE :
$$\frac{dFM}{dt} = \frac{1-p}{\rho_F}(EI-EE)$$
$$\frac{dLM}{dt} = \frac{p}{\rho_L}(EI-EE)$$ 
where FM is the fat mass, LM the lean mass, EI the energy intake and EE the energy expenditure. And $$p=\frac{C}{C+F}$$

```{r import, echo=FALSE}
rm(list=ls())
library(deSolve)
library(coda)
library(rootSolve)
library(FME)
library(plotrix)

dat <- read.table(file = "CLINICAL(copietravail).csv", sep= ',', header = TRUE)
  ######################################
  # BODYWEIGHT, FAT MASS AND LEAN MASS #
  ######################################
BW0 <- dat$BW0
BW1 <- dat$BW1
BW2 <- dat$BW2
BW5 <- dat$BW5

FM0 <- dat$TBFD0
FM2 <- dat$TBFD2
FM5 <- dat$TBFD5

adjust = subset(FM0/dat$TBFB0, is.na(FM0/dat$TBFB0)==F)
mean_adjust = mean(adjust)

FM0[18]=mean_adjust*dat$TBFB0[18]

#On a BW = LM + FM

LM0 <- BW0-FM0
LM2 <- BW2-FM2
LM5 <- BW5-FM5

  ##################
  # AGE AND HEIGHT #
  ##################
age0 <- dat$Age0
age2 <- dat$Age2
age5 <- dat$Age5
H <- dat$Height

BMI0 <- dat$BMI0
BMI1 <- dat$BMI1
BMI2 <- dat$BMI2
BMI5 <- dat$BMI5

adjust2 = subset(BMI1-BMI2, is.na(BMI1)==F)
mean_adjust2 = mean(adjust2)
BMI1[9] <- BMI2[9] - mean_adjust2
BMI1[20] <- BMI2[20] - mean_adjust2
BMI1[21] <- BMI2[21] - mean_adjust2

  ########
  # TIME #
  ########
T0 <- rep(0,41)
T2 <- dat$T2
T1 <- T2/2
T5 <- dat$T5

  ##############
  # PARAMETERS #
  ##############
pf <- 39500 #kJ/kg
pl <- 7600 #kJ/kg
gf <- 13 #kJ/kg/day
gl <- 92 #kJ/kg/day
nf <- 750 #kJ/kg 
nl <- 960 #kJ/kg
Btef <- 0.1
Bat <- 0.14
C <- 10.4*pl/pf #kg
tau <- 14 #jours
  #####################
  # PHYSICAL ACTIVITY #
  #####################
d0 <- ((1-Btef)*1.5-1)*(10*BW0+625*H-5*age0-161)*4.184
d2 <- ((1-Btef)*1.5-1)*(10*BW2+625*H-5*age2-161)*4.184
d5 <- ((1-Btef)*1.5-1)*(10*BW5+625*H-5*age5-161)*4.184

  #######################
  # ENERGY PARTITIONING #
  #######################
p2 <- C/(C+FM2) 
p5 <- C/(C+FM5)


```

## Modelling the weight loss of patients

There are some parameters which need to be determined from the data given by the Karolinska Institute : the energy expenditure (EE), the energy intake (EI) and K a constant. Kevin D. Hall gives us a formula to estimate the energy expenditure :
$$EE = K + \gamma_FF + \gamma_LL + \delta + TEF+AT+\eta_F\frac{dF}{dt}+\eta_L\frac{dL}{dt}$$
$$EE = \frac{K + \gamma_FF + \gamma_LL + \delta + TEF+AT+EI(\eta_F\frac{1-p}{\rho_F}+\eta_L\frac{p}{\rho_L})}{1+\eta_F\frac{1-p}{\rho_F}+\eta_L\frac{p}{\rho_L}}$$
TEF is the factor introducing the thermic effect of feeding and AT is the adaptive thermogenesis. Both represent the response of a sudden change of energy intake:
$TEF =  \beta_{TEF}\Delta EI$ and $AT = \beta_{TEF}\Delta EI(1-e^{-\frac{t}{\tau}})$
When the patient is weight stable it means that $EI = EE$. For example before the surgery the patients maintain their weight as $EI_0 = EE_0$.
It means that 
$$EE_0 = K + \gamma_FF_0 + \gamma_LL_0 + \delta_0$$
We can estimate $EE_0$ thanks to the Mifflin equation for women:
$$EE_0 = EI_0 = 10BW_0 + 625H - 5age_0 -161$$
Thus the constant K can be determined.
```{r energy, echo=FALSE}
  #########################
  # INITIAL ENERGY INTAKE #
  #########################
EI0 <- (10*BW0 + 625*H -5*age0-161)*1.5*4.184

EI1 <- function(t, Ts, Tf, EIi, EIs, EIf)
{
  s = (EIf-EIs)/(Tf-Ts) #garde le regime pendant 150 jours (~5 mois) puis reprise progressive de nourriture jusqu'au 900eme jour (~3 ans)
  if (t<=0){
    EIi
    
  }
  else if (t<=Ts){
    EIs
    
  }
  else{
    intake = (t-500)*s+EIs
    if (intake<EIf){
      intake
    }
    else{
      EIf
      
    }
  }
}

EI2 <- function(t, Ts, EIi, EIs, EIf)
{
  if (t<=0){
    EIi
    
  }
  else if (t<=Ts){
    EIs
    
  }
  else{
     EIf
  }
}
  ##############################
  # INITIAL ENERGY EXPENDITURE #
  ##############################
EE0 <- EI0

EE1 <- function(t, Ts, Tf, EIi, EIs, EIf, k, h, a, FM, LM){
  B <- Btef+Bat*(1-exp(-t/tau))
  PA <- ((1-Btef)*1.5-1)*4.184*(10*(FM+LM)+625*h-5*(a+t/365)-161)
  partF <- FM/(C+FM)
  partL <- 1-partF
  result <- (k + gf*FM + gl*LM + PA - EIi*B + EI1(t, Ts, Tf, EIi, EIs, EIf)*(B + partF*nf/pf + partL*nl/pl))/(1 + partF*nf/pf + partL*nl/pl)
  result
}

EE2 <- function(t, Ts, EIi, EIs, EIf, k, h, a, FM, LM){
  B <- Btef+Bat*(1-exp(-t/tau))
  PA <- ((1-Btef)*1.5-1)*4.184*(10*(FM+LM)+625*h-5*(a+t/365)-161)
  partF <- FM/(C+FM)
  partL <- 1-partF
  result <- (k + gf*FM + gl*LM + PA - EIi*B + EI2(t, Ts, EIi, EIs, EIf)*(B + partF*nf/pf + partL*nl/pl))/(1 + partF*nf/pf + partL*nl/pl)
  result
  }

  ##############
  # K CONSTANT #
  ##############
K <- EI0 - gf*FM0 - gl*LM0 - d0

```

```{r equation, echo=FALSE}
  ##############
  # EDO SYSTEM #
  ##############

EqBW1 <- function(t, y, parameters){

  EIi <- parameters[1]
  k <- parameters[2]
  h <- parameters[3]
  a <- parameters[4]
  Ts <- parameters[5]
  Tf <- parameters[6]
  EIs <- parameters[7]
  EIf <- parameters[8]
  partF <- y[1]/(C+y[1])
  partL <- 1-partF
  
  dF <- partF/pf * (EI1(t, Ts, Tf, EIi, EIs, EIf) - EE1(t, Ts, Tf, EIi, EIs, EIf, k, h, a, y[1], y[2]))
  dL <- partL/pl * (EI1(t, Ts, Tf, EIi, EIs, EIf) - EE1(t, Ts, Tf, EIi, EIs, EIf, k, h, a, y[1], y[2]))
  list(c(dF, dL))
}

EqBW2 <- function(t, y, parameters){

  EIi <- parameters[1]
  k <- parameters[2]
  h <- parameters[3]
  a <- parameters[4]
  Ts <- parameters[5]
  EIs <- parameters[6]
  EIf <- parameters[7]
  partF <- y[1]/(C+y[1])
  partL <- 1-partF
  
  dF <- partF/pf * (EI2(t, Ts, EIi, EIs, EIf) - EE2(t, Ts, EIi, EIs, EIf, k, h, a, y[1], y[2]))
  dL <- partL/pl * (EI2(t, Ts, EIi, EIs, EIf) - EE2(t, Ts, EIi, EIs, EIf, k, h, a, y[1], y[2]))
  list(c(dF, dL))
}

```
Now, the idea is to solve the model equations for each patients. We can then plot the results for both energy rates and bodyweight. This is an example for one patient in the cohort.
```{r individual graph, echo=FALSE}
  ########################
  # SOLVE FOR PATIENT 40 #
  ########################
soltime <- seq(0,2200)
parameters <- c(EI0[40], K[40], H[40], age0[40], 500,900)
init <- c(fatmass = FM0[40],leanmass = LM0[40])
Data <- data.frame(time = c(T2[40],T5[40]), fatmass = c(FM2[40],FM5[40]) , leanmass= c(LM2[40],LM5[40]))

modelcost <- function(P) {
  sol <- lsoda(y=init, times=soltime, func = EqBW1, parms = c(parameters,P[1],P[2]))
  return(modCost(sol,Data))
}

Fit <- modFit(f = modelcost, p = c(7800,10000))

EIsurg <- Fit$par[1]
EIfinal <- Fit$par[2]
  
parameters <- c(EI0[40], K[40], H[40], age0[40], 500, 900, EIsurg, EIfinal)
init <- c(fatmass = FM0[40],leanmass = LM0[40])
bestfit <- lsoda(y=init, times=soltime, func = EqBW1, parms = c(parameters))

  #####################
  # ENERGY RATE GRAPH #
  #####################

graphtime <- seq(-100,2200)
graphEI= rep(EI0[40], 100)
graphEE = rep(EE0[40], 100)
for (i in 101:2301){
  graphEI[i] <- EI1(graphtime[i], 500, 900, EI0[40], EIsurg, EIfinal)
  graphEE[i] <- EE1(graphtime[i], 500, 900, EI0[40], EIsurg, EIfinal, K[40], H[40], age0[40], bestfit[i-100,2], bestfit[i-100,3])
}

plot(graphtime, graphEI, type="l", xlab="Days", ylab="Energy rate ", col=1, ylim=c(1000, 15000))
lines(graphtime, graphEE, type ="l", lty = 1, col=2)
legend("bottomright",lty=c(1,1), cex=0.7, col=c(1,2), legend=c("Energy Intake rate", "Energy Expenditure rate"))
title(main= "Energy rates time course")


  ############################
  # WEIGHT TIME COURSE GRAPH #
  ############################

graphFM <- c(rep(FM0[40], 100), bestfit[,2])
graphLM <- c(rep(LM0[40], 100), bestfit[,3])
graphBW <- c(rep(BW0[40], 100), bestfit[,2]+bestfit[,3])

plot(graphtime, graphFM, type="l", ylim=c(0,160), xlab="Days", ylab="Weight in kg")
lines(graphtime, graphBW, type = "l", lty =1, col=4)
lines(graphtime, graphLM, type = "l", lty =1, col="dodgerblue4")
points(T0[40], FM0[40], pch=3)
points(T2[40], FM2[40], pch=3)
points(T5[40], FM5[40], pch=3)
points(T0[40], BW0[40], pch=19, col=4)
points(T2[40], BW2[40], pch=19, col=4)
points(T5[40], BW5[40], pch=19, col=4)
points(T0[40], LM0[40], pch=3, col="dodgerblue4")
points(T2[40], LM2[40], pch=3, col="dodgerblue4")
points(T5[40], LM5[40], pch=3, col="dodgerblue4")
title(main= "Bodyweight time course")
legend("bottomright", lty=c(1,1,1), legend=c("Bodyweight", "Fatmass","Leanmass"), col=c(4,1,"dodgerblue4"), cex=0.7)
```

## Comparison of our model to the body weight planner
In his paper, Kevin D. Hall mentions the web application, body weight planner, which consists in predict the energy intake during a period given the goal (time and weight goal). This application is based on the same equations we used for our model. To confirm our model, we decided to compare it to the application results by using the energy intake rates given to lose 40 kg in 500 days.

```{r comparison, echo=FALSE}
dat2 <- read.table(file = "planner.csv", sep= ',', header = TRUE)
ptime <- dat2$Day
pBW <- dat2$Weight
pFM <- dat2$FM
pLM <- pBW - pFM
pEI <- dat2$Intake
pEE <- dat2$Expenditure
pEIsurg <- pEI[1]
pEIfinal <- pEI[length(pEI)]

soltime <- seq(0,2200)
parameters <- c(EI0[40], K[40], H[40], age0[40], 500, pEIsurg, pEIfinal)
init <- c(fatmass = FM0[40],leanmass = LM0[40])
bestfit <- lsoda(y=init, times=soltime, func = EqBW2, parms = c(parameters))

graphEIc <- c()
graphEEc <- c()
for (i in 1:2201){
  graphEIc[i] <- EI2(soltime[i], 500, EI0[40], pEIsurg, pEIfinal)
  graphEEc[i] <- EE2(soltime[i], 500, EI0[40], pEIsurg, pEIfinal, K[40], H[40], age0[40], bestfit[i,2], bestfit[i,3])
}

plot(soltime, graphEIc, type="l", xlab="Days", ylab="Energy rate ", col=1, xlim=c(0, 500), ylim=c(1000, 15000))
lines(ptime, pEI, lty =2)
lines(soltime, graphEEc, type ="l", lty = 1, col=2)
lines(ptime, pEE, type ="l", lty = 2, col=2)
legend("bottomright",lty=c(1,1,2,2), cex=0.7, col=c(1,2,1,2), legend=c("Energy Intake rate", "Energy Expenditure rate", "Planner EI", "Planner EE"))
title(main= "Energy rates time course")

graphFM <- bestfit[,2]
graphLM <- bestfit[,3]
graphBW <- bestfit[,2]+bestfit[,3]

plot(soltime, graphFM, type="l", xlim=c(0, 500), ylim=c(0,140), xlab="Days", ylab="Weight in kg")
lines(ptime, pFM, type = "l", lty =2)
lines(soltime, graphBW, type = "l", lty =1, col=4)
lines(ptime, pBW, type = "l", lty =2, col=4)
lines(soltime, graphLM, type = "l", lty =1, col="dodgerblue4")
lines(ptime, pLM, type = "l", lty =2, col="dodgerblue4")
legend("bottomright", lty=c(1,1,1,2,2,2), legend=c("BW", "FM","LM", "Planner BW", "Planner FM", "Planner LM"), col=c(4,1,"dodgerblue4",4,1,"dodgerblue4"), cex=0.7)
title(main= "Bodyweight time course")
```
## Average patients
```{r average, echo=FALSE}
dBMI <- BMI0 - BMI5
tertile<- unname(quantile(dBMI, probs = c(0.33, 0.67)))

g1 <- c()
g2 <- c()
g3 <- c()

for (i in 1:41){
  if (dBMI[i] <= tertile[1]){
    g1 <- c(g1, i)
  }
  else if (dBMI[i] <= tertile[2]){
    g2 <- c(g2, i)
  }
  else {
    g3 <- c(g3, i)
  }
}

st_error<- function(x){
  result <- sd(x)/sqrt(length(x))
  result
}

Tg <- c(0,1,2,5)
BMIg1 <- c(mean(BMI0[g1]), mean(BMI1[g1]), mean(BMI2[g1]), mean(BMI5[g1]))
errg1 <- c(st_error(BMI0[g1]), st_error(BMI1[g1]), st_error(BMI2[g1]), st_error(BMI5[g1]))
BMIg2 <- c(mean(BMI0[g2]), mean(BMI1[g2]), mean(BMI2[g2]), mean(BMI5[g2]))
errg2 <- c(st_error(BMI0[g2]), st_error(BMI1[g2]), st_error(BMI2[g2]), st_error(BMI5[g2]))
BMIg3 <- c(mean(BMI0[g3]), mean(BMI1[g3]), mean(BMI2[g3]), mean(BMI5[g3]))
errg3 <- c(st_error(BMI0[g3]), st_error(BMI1[g3]), st_error(BMI2[g3]), st_error(BMI5[g3]))

plot(Tg, BMIg1, type = "l", ylim=c(25, 50), xlab="Year of investigation", ylab="BMI (kg/m²)")
plotCI(Tg, BMIg1, uiw = errg1, lwd =2, col = 1, add =T)
lines(Tg, BMIg2, col=2)
plotCI(Tg, BMIg2, uiw = errg2, lwd =2, col = 2, add =T)
lines(Tg, BMIg3, col=3)
plotCI(Tg, BMIg3, uiw = errg3, lwd =2, col = 3, add =T)

  # # # # # #
  # GROUP 1 #
  # # # # # #
A1_age0 <- mean(age0[g1])
A1_BW0 <- mean(BW0[g1])
A1_FM0 <- mean(FM0[g1])
A1_LM0 <- mean(LM0[g1])
A1_H <- mean(H[g1])
A1_d0 <- ((1-Btef)*1.5-1)*(10*A1_BW0+625*A1_H-5*A1_age0-161)*4.184
A1_EI0 <- (10*A1_BW0 + 625*A1_H -5*A1_age0-161)*1.5*4.184
A1_EE0 <- A1_EI0
A1_K <- A1_EI0 - gf*A1_FM0 - gl*A1_LM0 - A1_d0

A1_parameters <- c(A1_EI0, A1_K, A1_H, A1_age0, 380, 1500)
A1_init <- c(fatmass = A1_FM0,leanmass = A1_LM0)
A1_Data <- data.frame(time = c(T2[g1],T5[g1]), fatmass = c(FM2[g1],FM5[g1]) , leanmass= c(LM2[g1],LM5[g1]))
soltime = seq(0,2200)

A1_modelcost <- function(P) {
  sol <- lsoda(y=A1_init, times=soltime, func = EqBW1, parms = c(A1_parameters,P[1],P[2]))
  return(modCost(sol,A1_Data))
}

A1_Fit <- modFit(f = A1_modelcost, p = c(8264.651, 11224.78))

A1_EIsurg <- A1_Fit$par[1]
A1_EIfinal <- A1_Fit$par[2]
A1_EIsurgCI <- unname(c(A1_EIsurg + summary(A1_Fit)$par[1,2]*qt(0.05, 2), A1_EIsurg + summary(A1_Fit)$par[1,2]*qt(0.95, 2)))
A1_EIfinalCI <- unname(c(A1_EIfinal + summary(A1_Fit)$par[2,2]*qt(0.05, 2), A1_EIfinal + summary(A1_Fit)$par[2,2]*qt(0.95, 2)))
A1_bestfit <- lsoda(y=A1_init, times=soltime, func = EqBW1, parms = c(A1_parameters,A1_EIsurg, A1_EIfinal))
A1_fitinf <- lsoda(y=A1_init, times=soltime, func = EqBW1, parms = c(A1_parameters,A1_EIsurgCI[1], A1_EIfinalCI[1]))
A1_fitsup <- lsoda(y=A1_init, times=soltime, func = EqBW1, parms = c(A1_parameters,A1_EIsurgCI[2], A1_EIfinalCI[2]))

plot(soltime, (A1_bestfit[,2]+A1_bestfit[,3])/A1_H^2, type='l', xlab = "Days", ylab="BMI (kg/m²)", ylim=c(20,50))
lines(soltime, (A1_fitinf[,2]+A1_fitinf[,3])/A1_H^2, type='l', lty=2)
lines(soltime, (A1_fitsup[,2]+A1_fitsup[,3])/A1_H^2, type='l', lty=2)
points(T2[g1], BMI2[g1])
points(T5[g1], BMI5[g1])
title(main="BMI change overtime for the rebounder group")
legend("topleft", cex=0.7, lty=c(1,2), col=c(1,1), legend=c("Mean BMI time course", "Expected inter-individual BMI variability"))

# # # # # #
# GROUP 2 #
# # # # # #

A2_age0 <- mean(age0[g2])
A2_BW0 <- mean(BW0[g2])
A2_FM0 <- mean(FM0[g2])
A2_LM0 <- mean(LM0[g2])
A2_H <- mean(H[g2])
A2_d0 <- ((1-Btef)*1.5-1)*(10*A2_BW0+625*A2_H-5*A2_age0-161)*4.184
A2_EI0 <- (10*A2_BW0 + 625*A2_H -5*A2_age0-161)*1.5*4.184
A2_EE0 <- A2_EI0
A2_K <- A2_EI0 - gf*A2_FM0 - gl*A2_LM0 - A2_d0

A2_parameters <- c(A2_EI0, A2_K, A2_H, A2_age0, 400, 1500)
A2_init <- c(fatmass = A2_FM0,leanmass = A2_LM0)
A2_Data <- data.frame(time = c(T2[g2],T5[g2]), fatmass = c(FM2[g2],FM5[g2]) , leanmass= c(LM2[g2],LM5[g2]))
soltime = seq(0,2200)

A2_modelcost <- function(P) {
  sol <- lsoda(y=A2_init, times=soltime, func = EqBW1, parms = c(A2_parameters,P[1],P[2]))
  return(modCost(sol,A2_Data))
}

A2_Fit <- modFit(f = A2_modelcost, p = c(7173.003,9882.749))

A2_EIsurg <- A2_Fit$par[1]
A2_EIfinal <- A2_Fit$par[2]
A2_EIsurgCI <- unname(c(A2_EIsurg + summary(A2_Fit)$par[1,2]*qt(0.05, 50), A2_EIsurg + summary(A2_Fit)$par[1,2]*qt(0.95, 50)))
A2_EIfinalCI <- unname(c(A2_EIfinal + summary(A2_Fit)$par[2,2]*qt(0.05, 50), A2_EIfinal + summary(A2_Fit)$par[2,2]*qt(0.95, 50)))
A2_bestfit <- lsoda(y=A2_init, times=soltime, func = EqBW1, parms = c(A2_parameters,A2_EIsurg, A2_EIfinal))
A2_fitinf <- lsoda(y=A2_init, times=soltime, func = EqBW1, parms = c(A2_parameters,A2_EIsurgCI[1], A2_EIfinalCI[1]))
A2_fitsup <- lsoda(y=A2_init, times=soltime, func = EqBW1, parms = c(A2_parameters,A2_EIsurgCI[2], A2_EIfinalCI[2]))

plot(soltime, (A2_bestfit[,2]+A2_bestfit[,3])/A2_H^2, type='l', xlab = "Days", ylab="BMI (kg/m²)", ylim=c(20,50), col=2)
lines(soltime, (A2_fitinf[,2]+A2_fitinf[,3])/A2_H^2, type='l', lty=2, col=2)
lines(soltime, (A2_fitsup[,2]+A2_fitsup[,3])/A2_H^2, type='l', lty=2, col=2)
points(T2[g2], BMI2[g2], col=2)
points(T5[g2], BMI5[g2], col=2)
title(main="BMI change overtime for the first weight stable group")
legend("topleft", cex=0.7, lty=c(1,2), col=c(2,2), legend=c("Mean BMI time course", "Expected inter-individual BMI variability"))

# # # # # #
# GROUP 3 #
# # # # # #

A3_age0 <- mean(age0[g3])
A3_BW0 <- mean(BW0[g3])
A3_FM0 <- mean(FM0[g3])
A3_LM0 <- mean(LM0[g3])
A3_H <- mean(H[g3])
A3_d0 <- ((1-Btef)*1.5-1)*(10*A3_BW0+625*A3_H-5*A3_age0-161)*4.184
A3_EI0 <- (10*A3_BW0 + 625*A3_H -5*A3_age0-161)*1.5*4.184
A3_EE0 <- A3_EI0
A3_K <- A3_EI0 - gf*A3_FM0 - gl*A3_LM0 - A3_d0

A3_parameters <- c(A3_EI0, A3_K, A3_H, A3_age0, 676, 900)
A3_init <- c(fatmass = A3_FM0,leanmass = A3_LM0)
A3_Data <- data.frame(time = c(T2[g3],T5[g3]), fatmass = c(FM2[g3],FM5[g3]) , leanmass= c(LM2[g3],LM5[g3]))
soltime = seq(0,2200)

A3_modelcost <- function(P) {
  sol <- lsoda(y=A3_init, times=soltime, func = EqBW1, parms = c(A3_parameters,P[1],P[2]))
  return(modCost(sol,A3_Data))
}

A3_Fit <- modFit(f = A3_modelcost, p = c(6795.718,9250.329))

A3_EIsurg <- A3_Fit$par[1]
A3_EIfinal <- A3_Fit$par[2]
A3_EIsurgCI <- unname(c(A3_EIsurg + summary(A3_Fit)$par[1,2]*qt(0.05, 2), A3_EIsurg + summary(A3_Fit)$par[1,2]*qt(0.95, 2)))
A3_EIfinalCI <- unname(c(A3_EIfinal + summary(A3_Fit)$par[2,2]*qt(0.05, 2), A3_EIfinal + summary(A3_Fit)$par[2,2]*qt(0.95, 2)))
A3_bestfit <- lsoda(y=A3_init, times=soltime, func = EqBW1, parms = c(A3_parameters,A3_EIsurg, A3_EIfinal))
A3_fitinf <- lsoda(y=A3_init, times=soltime, func = EqBW1, parms = c(A3_parameters,A3_EIsurgCI[1], A3_EIfinalCI[1]))
A3_fitsup <- lsoda(y=A3_init, times=soltime, func = EqBW1, parms = c(A3_parameters,A3_EIsurgCI[2], A3_EIfinalCI[2]))

plot(soltime, (A3_bestfit[,2]+A3_bestfit[,3])/A3_H^2, type='l', xlab = "Days", ylab="BMI (kg/m²)", ylim=c(20,50), col=3)
lines(soltime, (A3_fitinf[,2]+A3_fitinf[,3])/A3_H^2, type='l', lty=2, col=3)
lines(soltime, (A3_fitsup[,2]+A3_fitsup[,3])/A3_H^2, type='l', lty=2, col=3)
points(T2[g3], BMI2[g3], col=3)
points(T5[g3], BMI5[g3], col=3)
title(main="BMI change overtime for the second weight stable group")
legend("topleft", cex=0.7, lty=c(1,2), col=c(3,3), legend=c("Mean BMI time course", "Expected inter-individual BMI variability"))

```